@import resources._
@nav(titlePage = "Empresas"){

<div class="row center">    
    <h2 id="name-business-title"></h2>   
    <br/>
    <br/>
    <small> Los campos con  
        <span class="text-danger">*</span>
        son obligatorios
    </small> 
    <br/>
    <br/>
    <div class="row row-centered">
        <div class="col-md-6 col-centered">
            <form id="picture-business-form" class="form-horizontal form-picture">
                <div class="form-group">
                    <div class="col-md-12">
                        <ul class="list-group text-center">
                            <li class="list-group-item">
                                Imagen de la empresa
                            </li>
                            <li id="content-img-business" class="list-group-item content-img">
                                <img id="picture-business-img" src="@routes.Assets.at("images/gift/action.png")"/>
                            </li>
                            <li >
                                <button type="button" id="picture-business-upload" onclick="openEditImagePopup()" class="btn list-group-item" >
                                    <i id="picture-business-icon" class="fa fa-pencil fa-fw"></i>
                                    &nbsp;Editar imagen</button>
                            </li>
                        </ul>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <form id="Business-form" class="form-horizontal">
      <fieldset class="col-md-4">
         <legend>Datos de empresa</legend>
         <div class="col-md-12">
            <span class="text-danger">*</span>
            <div class="form-group has-feedback">
                <input type="text" class="form-control input-lg" name="trade-name-business" data-required="true" placeholder="Nombre comercial Empresa">
                <span class="form-control-feedback"></span>
                <small class="i-form-error-msg text-danger hidden">Este campo es requerido!</small>
            </div>
        </div>
        <div class="col-md-12">
            <span class="text-danger">*</span>
            <div class="form-group has-feedback">
                <input type="text" class="form-control input-lg" name="legal-name-business" data-required="true" placeholder="Nombre legal Empresa">
                <span class="form-control-feedback"></span>
                <small class="i-form-error-msg text-danger hidden">Este campo es requerido!</small>
            </div>
        </div>
        <div class="col-md-12">
            <span class="text-danger">*</span>
            <div class="form-group has-feedback">
                <input type="text" class="form-control input-lg" name="nit-business" data-required="true" placeholder="NIT Empresa">
                <span class="form-control-feedback"></span>
                <small class="i-form-error-msg text-danger hidden">Este campo es requerido!</small>
            </div>
        </div>
        <div class="col-md-12">
            <span class="text-danger">*</span>
            <div class="form-group has-feedback"> 
                <div id="business-type-list" data-required="true" data-name="business-type" class="i-select i-select-lg i-select-dafault"></div>
                <small class="i-form-error-msg text-danger hidden">Este campo es requerido!</small>
            </div>
        </div>
        <div id="other-business-type" class="col-md-12 hidden">
            <span class="text-danger">*</span>
            <div class="form-group has-feedback">
                <input type="text" class="form-control input-lg" name="other-business-type"  placeholder="Cual ?">
                <span class="form-control-feedback"></span>
                <small class="i-form-error-msg text-danger hidden">Este campo es requerido!</small>
            </div>
        </div>
        <div class="col-md-12">
            <span class="text-danger">*</span>
            <div class="form-group has-feedback">
                <input type="text" class="form-control input-lg" name="web-site-business" data-required="true" placeholder="p&aacute;gina Web">
                <span class="form-control-feedback"></span>
                <small class="i-form-error-msg text-danger hidden">Este campo es requerido!</small>
            </div>
        </div>
        <div class="col-md-12">
            <span class="text-danger">*</span>
            <div class="form-group has-feedback">
                <input type="text" class="form-control input-lg" name="name-legal-representative-business" data-required="true" placeholder="Nombre Representante legal">
                <span class="form-control-feedback"></span>
                <small class="i-form-error-msg text-danger hidden">Este campo es requerido!</small>
            </div>
        </div>
        <div class="col-md-12">
            <span class="text-danger">*</span>
            <div class="form-group has-feedback"> 
                <div id="document-type-list" data-required="true" data-name="document-type" class="i-select i-select-lg i-select-dafault"></div>
                <small class="i-form-error-msg text-danger hidden">Este campo es requerido!</small>
            </div>
        </div>
        <div class="col-md-12">
            <span class="text-danger">*</span>
            <div class="form-group has-feedback">
                <input type="text" class="form-control input-lg" name="document-legal-representative-business" data-required="true" placeholder="Cedula Representante legal">
                <span class="form-control-feedback"></span>
                <small class="i-form-error-msg text-danger hidden">Este campo es requerido!</small>
            </div>
        </div>

        <div class="col-md-12">
            <span class="text-danger">*</span>
            <div class="form-group has-feedback">
                <input type="text" class="form-control input-lg" name="place-of-issue-legal-representative-business" data-required="true" placeholder="Lugar de expedici칩n Documento Rep. Legal">
                <span class="form-control-feedback"></span>
                <small class="i-form-error-msg text-danger hidden">Este campo es requerido!</small>
            </div>
        </div>
    </fieldset>

    <fieldset class="col-md-4">
     <legend>Datos de Contacto</legend>
     <div class="col-md-12">
        <span class="text-danger">*</span>
        <div class="form-group has-feedback">
            <input type="text" class="form-control input-lg" name="name-contact" data-required="true" placeholder="Nombre Contacto">
            <span class="form-control-feedback"></span>
            <small class="i-form-error-msg text-danger hidden">Este campo es requerido!</small>
        </div>
    </div>
    <div class="col-md-12">
        <span class="text-danger">*</span>
        <div class="form-group has-feedback">
            <input type="text" class="form-control input-lg" name="email-contact" data-required="true" placeholder="Email Contacto">
            <span class="form-control-feedback"></span>
            <small class="i-form-error-msg text-danger hidden">Este campo es requerido!</small>
        </div>
    </div>
    <div id="password">
        <div class="col-md-12">
            <span class="text-danger">*</span>
            <div class="form-group has-feedback">
                <input type="password" class="form-control input-lg" name="password-contact" data-required="true" placeholder="Contrase침a">
                <span class="form-control-feedback"></span>
                <small class="i-form-error-msg text-danger hidden">Este campo es requerido!</small>
            </div>
        </div>
        <div class="col-md-12">
            <span class="text-danger">*</span>
            <div class="form-group has-feedback">
                <input type="password" class="form-control input-lg" data-required="true" data-equalsto="password-contact" placeholder="Confirmar Contrase침a">
                <span class="form-control-feedback"></span>
                <small class="i-form-error-msg text-danger hidden">La contrase침a no coincide!</small>
            </div>
        </div>
    </div>
    <div class="col-md-12">
        <span class="text-danger">*</span>
        <div class="form-group has-feedback">
            <input type="text" class="form-control input-lg" name="phone-contact" data-required="true" placeholder="Tel復ono Contacto">
            <span class="form-control-feedback"></span>
            <small class="i-form-error-msg text-danger hidden">Este campo es requerido!</small>
        </div>
    </div>
    <div class="col-md-12">
        <div class="form-group has-feedback">
            <input type="text" class="form-control input-lg" name="extension-phone-contact"  placeholder="Extenci蚤 Tel復ono">                    
        </div>
    </div>
    <div class="col-md-12">
        <span class="text-danger">*</span>
        <div class="form-group has-feedback">
            <input type="text" class="form-control input-lg" name="mobile-phone-contact" data-required="true" placeholder="Tel復ono Celular">
            <span class="form-control-feedback"></span>
            <small class="i-form-error-msg text-danger hidden">Este campo es requerido!</small>
        </div>
    </div>
    <div class="col-md-12">
        <span class="text-danger">*</span>
        <div class="form-group has-feedback">
            <input type="text" class="form-control input-lg" name="address-contact" data-required="true" placeholder="Direcci蚤 Contacto">
            <span class="form-control-feedback"></span>
            <small class="i-form-error-msg text-danger hidden">Este campo es requerido!</small>
        </div>
    </div>
</fieldset>

   <fieldset class="col-md-4">
      <legend>Datos de Servicio al cliente</legend>
      <div class="col-md-12">
        <span class="text-danger">*</span>
        <div class="form-group has-feedback">
            <input type="text" class="form-control input-lg" name="email-customer-service" placeholder="Email Servicio al cliente">
            <span class="form-control-feedback"></span>
            <small class="i-form-error-msg text-danger hidden">Este campo es requerido!</small>
        </div>
    </div>
    <div class="col-md-12">
        <span class="text-danger">*</span>
        <div class="form-group has-feedback">
            <input type="text" class="form-control input-lg" name="phone-customer-service"  placeholder="Tel復ono Servicio al cliente">
            <span class="form-control-feedback"></span>
            <small class="i-form-error-msg text-danger hidden">Este campo es requerido!</small>
        </div>
    </div>
    <div class="col-md-12">
        <div class="form-group has-feedback">
            <input type="text" class="form-control input-lg" name="extension-phone-customer-service"  placeholder="Extenci蚤 Tel復ono">                    
        </div>
    </div>
    <div class="col-md-12">
        <span class="text-danger">*</span>
        <div class="form-group has-feedback">
            <input type="text" class="form-control input-lg" name="mobile-phone-customer-service" placeholder="Tel復ono Celular">
            <span class="form-control-feedback"></span>
            <small class="i-form-error-msg text-danger hidden">Este campo es requerido!</small>
        </div>
    </div>
    </fieldset>
       
<div id="terms-conditions-privacy-policy" class="col-md-12 hidden">
    <div class="form-gropup">
     <p>Al hacer clic en registar aceptas los
        <a href="/termsAndConditions" rel="external">terminos y condiciones</a> de megift
        y que has le&iacute;do las
        <a href="/privacyPolicy" rel="external">pol&iacute;ticas de privacidad.</a>
    </p>
</div>
</div>
<div class="col-md-12 ">
    <div class="form-group">
        <button id="businessBtn" type="submit" class="btn btn-success btn-lg btn-block">Guardar
            <i id="business-btn-ico"></i></button>
        </div>
    </div>    
    <input type="hidden" id="id-business" name="id-business" value="0">
    <input type="hidden" id="id-contact" name="id-contact" value="0">
    <input type="hidden" id="id-phone-contact" name="id-phone-contact" value="0">    
    <input type="hidden" id="id-address-contact" name="id-address-contact" value="0">    
    <input type="hidden" id="id-location-contact" name="id-location-contact" value="0">    
    <input type="hidden" id="id-legal-representative" name="id-legal-representative" value="0">
    <input type="hidden" id="id-document-legal-representative" name="id-document-legal-representative" value="0">    
    <input type="hidden" id="id-picture-business" name="id-picture-business" value="0">
    <input type="hidden" id="id-customer-service" name="id-customer-service" value="0">
</form>
</div>
<div id="success-popup" class="i-popup-panel i-popup-success hidden text-justify">
    <h3>Bienvenido</h3>
    <h4>Tu cuenta ha sido creada con &eacute;xito</h4>
    <a href="/login" class="btn btn-success btn-lg btn-block">Aceptar</a>
</div>
    <div  id="edit-img-popup" class="i-popup-panel i-popup-primary hidden">                         
        <form  class="form-horizontal">
            <div class="row row-centered">
                <div class="col-md-7 col-centered"> 
                    <h4 id="action-text-edit-img" >Editar imagen de la empresa</h4>             
                    <div class="img-container">
                        <img id="edit-picture" src="" alt="Picture">
                    </div>
                </div>
            </div> 
            <div class="row row-centered">
                <div class="col-md-7 col-centered docs-buttons">
                    <div class="btn-group">                 
                        <button class="btn btn-default btn-lg" data-method="zoom" data-option="0.1" type="button" title="Zoom In">
                            <span class="docs-tooltip" data-toggle="tooltip" title="$().cropper(&quot;zoom&quot;, 0.1)">
                                <span class="fa fa-search-plus"></span>
                            </span>
                        </button>
                        <button class="btn btn-default btn-lg" data-method="zoom" data-option="-0.1" type="button" title="Zoom Out">
                            <span class="docs-tooltip" data-toggle="tooltip" title="$().cropper(&quot;zoom&quot;, -0.1)">
                                <span class="fa fa-search-minus"></span>
                            </span>
                        </button>
                        <button class="btn btn-default btn-lg" data-method="rotate" data-option="-90" type="button" title="Rotate Left">
                            <span class="docs-tooltip" data-toggle="tooltip" title="$().cropper(&quot;rotate&quot;, -90)">
                                <span class="fa fa-undo"></span>
                            </span>
                        </button>
                        <button class="btn btn-default btn-lg" data-method="rotate" data-option="90" type="button" title="Rotate Right">
                            <span class="docs-tooltip" data-toggle="tooltip" title="$().cropper(&quot;rotate&quot;, 90)">
                                <span class="fa fa-repeat"></span>
                            </span>
                        </button>                                           
                        <label style="margin-left:10px" class="btn btn-primary btn-lg btn-upload" for="inputImage" title="Upload image file">
                            <input class="sr-only" id="inputImage" name="file" type="file" accept="image/*">
                            <span class="docs-tooltip" data-toggle="tooltip" title="Import image with Blob URLs">
                                <span class="fa fa-upload">&nbsp;Subir imagen</span>
                            </span>
                        </label>                    
                        <button id="save-img-btn" class="btn btn-success btn-lg" data-method="getCroppedCanvas" data-option="{ &quot;width&quot;: 240, &quot;height&quot;: 120 }" type="button">
                            <span class="docs-tooltip" data-toggle="tooltip" title="$().cropper(&quot;getCroppedCanvas&quot;, { &quot;width&quot;: 240, &quot;height&quot;: 120 })">
                                <span id="save-img-ico" class="fa fa-floppy-o"></span>&nbsp;Guardar cambios
                            </span>
                        </button>
                    </div>
                </div>  
            </div>
        </form>
        <div class="row">
            <div class="col-md-2 pull-right">
                <div class="form-group ">
                    <button type="button" id="edit-img-cancel-btn" class="btn btn-default btn-lg btn-block i-popup-close">
                        Cancelar
                        <i id="edit-img-cancel-btn-icon"><i>
                        </button>
                    </div>
                </div>   
            </div>
        </div>

<script>
//atributes
var typeBusinessView = sessionStorage.getItem('type-business-view');
var nav = document.getElementById('nav');
var nameBusinessTitle = document.getElementById('name-business-title');
var OTHER_TYPE_BUSINESS = 9;
//document type list
var documentType = new Select(document.getElementById('document-type-list'),'/documentTypeList',function(){documentType.selectItem(0)});
//business type lisst
var businessType = new Select(document.getElementById('business-type-list'), '/businessTypeList',function(){businessType.selectItem(0)});
//forms
var businessForm = new Form(document.getElementById('Business-form'));
//buttonss
var businessBtn = document.getElementById('businessBtn');
//popup success
var successPopup = new Popup(document.getElementById('success-popup'));
var editImagePopup = new Popup(document.getElementById('edit-img-popup'));

 if(typeBusinessView>0){//Adminstrar empresa
    //load data
    loadBusiness(); 
 }else{//Registrar empresa
    nav.classList.add('hidden');
    document.getElementById('terms-conditions-privacy-policy').classList.remove('hidden');
    nameBusinessTitle.textContent = 'Registrar Empresa';
    document.getElementById('picture-business-upload').disabled = true;
    //remove sessionStorage
    sessionStorage.removeItem('type-business-view');
}
//select other type business
businessType.onchange(function(){    
    if(businessType.getOption()==OTHER_TYPE_BUSINESS){//other type
        var otherType = document.getElementById('other-business-type');
        if(otherType.classList.contains('hidden')){
            otherType.classList.remove('hidden');
            otherType.classList.add('show');
        } 
    }else{
        var otherType = document.getElementById('other-business-type');
        if(otherType.classList.contains('show')){
            otherType.classList.remove('show');
            otherType.classList.add('hidden');
        } 
    }
});
//form business
businessForm.onsubmit(function(){
    if(businessForm.isValid()){
     var businessxHR = new XHR('POST','/saveBusiness');
     businessxHR.setContentType('application/x-www-form-urlencoded;charset=UTF-8');
     businessxHR.onBeforeSend(function(){
        businessBtn.disabled = true;
        document.getElementById('business-btn-ico').className = 'fa fa-spinner fa-spin';
    });
     businessxHR.onReady(function (xhr) {   
       businessBtn.disabled = false;
       document.getElementById('business-btn-ico').className = '';
       if(xhr.responseText === SUCCESS_RESPONSE){    
           if(typeBusinessView>0){         
              notification.success('La empresa se actualizo correctamente');
              document.getElementById('picture-business-upload').disabled = false;
          }else{
            successPopup.show();
        }        
    }else{
      businessBtn.disabled = false;
      notification.danger(xhr.responseText);
  }         
});
     businessxHR.onError(function(xhr){
      businessBtn.disabled = false;
      alert(xhr.responseText);
      console.log(xhr); 
  });
     businessxHR.send(businessForm.serialize());
 }
});
//load business
function loadBusiness(){
    document.getElementsByName('id-business')[0].value = '0';      
    //hidden controls
    var ps = document.getElementById('password');
    ps.classList.add('hidden');   
    //quit required to controls
    var inputs = document.querySelectorAll("input[type=password]");
    delete inputs[0].dataset.required;
    delete inputs[1].dataset.required;
    delete inputs[1].dataset.equalsto;
    //load data
    var loadBusinessxHR = new XHR('GET','/loadBusiness');
    loadBusinessxHR.setContentType('application/x-www-form-urlencoded;charset=UTF-8');
    loadBusinessxHR.onBeforeSend(function(){
        nameBusinessTitle.textContent = 'Cargando datos de la empresa';
    });
    loadBusinessxHR.onReady(function (xhr) {  
        var business = JSON.parse(xhr.responseText);
        nameBusinessTitle.textContent = business.tradeName;
        document.getElementsByName('trade-name-business')[0].value = business.tradeName;
        document.getElementsByName('legal-name-business')[0].value = business.legalName;
        document.getElementsByName('nit-business')[0].value = business.nit;
        document.getElementsByName('web-site-business')[0].value = business.webSite;          
        businessType.selectItem(business.type.id);
        if(business.type.id === OTHER_TYPE_BUSINESS){
          document.getElementsByName('other-business-type')[0].value = business.otherType; 
          var otherType = document.getElementById('other-business-type');
          if(otherType.classList.contains('hidden')){
            otherType.classList.remove('hidden');
            otherType.classList.add('show');
        }   
    } 
    document.getElementsByName('name-legal-representative-business')[0].value = business.legalRepresentative.name;
    document.getElementsByName('document-legal-representative-business')[0].value = business.legalRepresentative.document.document; 
    documentType.selectItem(business.legalRepresentative.document.type.id);
    document.getElementsByName('place-of-issue-legal-representative-business')[0].value = business.legalRepresentative.document.placeOfIssue;
    document.getElementsByName('name-contact')[0].value = business.contact.name;
    var emailContact = document.getElementsByName('email-contact')[0];
    emailContact.value = business.contact.login.email;    
    emailContact.disabled = true;
    document.getElementsByName('phone-contact')[0].value = business.contact.location.phone.number;
    document.getElementsByName('extension-phone-contact')[0].value = business.contact.location.phone.extension;
    document.getElementsByName('mobile-phone-contact')[0].value = business.contact.location.phone.mobile;
    document.getElementsByName('address-contact')[0].value = business.contact.location.address.address;
    document.getElementsByName('id-business')[0].value = business.id;
    document.getElementsByName('id-contact')[0].value = business.contact.id;
    document.getElementsByName('id-phone-contact')[0].value = business.contact.location.phone.id;
    document.getElementsByName('id-address-contact')[0].value = business.contact.location.address.id;
    document.getElementsByName('id-location-contact')[0].value = business.contact.location.id;
    document.getElementsByName('id-legal-representative')[0].value = business.legalRepresentative.id;
    document.getElementsByName('id-document-legal-representative')[0].value = business.legalRepresentative.document.id;
    var imageBusiness = document.getElementById('picture-business-img');
    var picture = business.picture;
    if (picture.id > 0) {        
    	imageBusiness.src = completePath(picture.path);        
    } else {
        imageBusiness.src = '@routes.Assets.at("images/gift/action.png")';
    }
});
loadBusinessxHR.onError(function(xhr){   	
 alert(xhr.responseText);
 console.log(xhr); 
});
loadBusinessxHR.send();
}

function openEditImagePopup(){    
    var picture = document.getElementById('edit-picture');    
    var tmpPicture = document.getElementById('picture-business-img');    
    picture.src = tmpPicture.src;    
    initCropper();
    editImagePopup.show();
}
function dataURItoBlob(dataURI) {
        // convert base64/URLEncoded data component to raw binary data held in a string
        var byteString;
        if (dataURI.split(',')[0].indexOf('base64') >= 0)
            byteString = atob(dataURI.split(',')[1]);
        else
            byteString = unescape(dataURI.split(',')[1]);
        // separate out the mime component
        var mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];
        // write the bytes of the string to a typed array
        var ia = new Uint8Array(byteString.length);
        for (var i = 0; i < byteString.length; i++) {
            ia[i] = byteString.charCodeAt(i);
        }
        return new Blob([ia], {type:mimeString});
    }
    function uploadImage(picture,action,target,parameters){
        try{                
            var formData = new FormData();
            var file = dataURItoBlob(picture);
            var type = file.type.split('/')[1];
            formData.append('picture', dataURItoBlob(picture),new Date().getTime()+'.'+type);
            formData.append(parameters.pictureId.name, parameters.pictureId.value);
            formData.append(parameters.objectId.name, parameters.objectId.value);
            var uploadPictureGiftXHR = new XHR('POST',action);
            var icon = document.getElementById('edit-img-cancel-btn-icon');
            var icon2 = document.getElementById('save-img-ico');
            var btn =  document.getElementById('edit-img-cancel-btn');
            var btn2 = document.getElementById('save-img-btn');
            uploadPictureGiftXHR.onBeforeSend(function () {
                btn.disabled = true;
                btn2.disabled = true;
                icon.className = 'fa fa-spinner fa-spin';
                icon2.className = 'fa fa-spinner fa-spin';
            });
            uploadPictureGiftXHR.onReady(function (xhr) {
                btn.disabled = false;
                btn2.disabled = false;
                icon.className = '';
                icon2.className = 'fa fa-floppy-o';
                var response = xhr.responseText;
                if (response === SUCCESS_RESPONSE) {
                    notification.success('La foto se guardo correctamente!');                       
                    document.getElementById(target).src= picture;   
                    editImagePopup.closeAll();
                } else {
                    notification.danger(response);
                    editImagePopup.closeAll();
                }
            });
            uploadPictureGiftXHR.onError(function(xhr){
                btn.disabled = false;
                btn2.disabled = false;
                icon.className = '';
                icon2.className = 'a fa-floppy-o';
                alert(xhr.responseText);
                console.log(xhr); 
                editImagePopup.closeAll();
            });
            uploadPictureGiftXHR.send(formData);
        }catch(ex){
            console.log(ex);
            alert(ex.message);
        }
    }

function initCropper(){
        var $image = $('.img-container > img');
        $image.cropper({                
            aspectRatio: 16 / 9,
            autoCropArea: 0.65,         
            highlight: false,
            dragCrop: false,
            movable: false,
            resizable: false,
            minContainerWidth:340,
            minContainerHeight:220,
            minCropBoxWidth:340,
            minCropBoxHeight:220
        });
        // Methods
        $(document.body).on('click', '[data-method]', function () {
            var data = $(this).data(),
            $target,
            result;
            if (data.method) {
              data = $.extend({}, data); // Clone a new one
              if (typeof data.target !== 'undefined') {
                $target = $(data.target);
                if (typeof data.option === 'undefined') {
                    try {
                        data.option = JSON.parse($target.val());
                    } catch (e) {
                        console.log(e.message);
                    }
                }
              }
              result = $image.cropper(data.method, data.option);
              if (data.method === 'getCroppedCanvas') {                                      
                    var parameters = {
                        pictureId:{
                            name:'id-picture-business',
                            value:document.getElementsByName('id-picture-business')[0].value
                        },
                        objectId:{
                            name:'id-business',
                            value:document.getElementsByName('id-business')[0].value
                        }
                    };
                    uploadImage(result.toDataURL(),'/uploadpictureBusiness','picture-business-img',parameters);
                }
              }          
      }).on('keydown', function (e) {
        switch (e.which) {
            case 37:
            e.preventDefault();
            $image.cropper('move', -1, 0);
            break;
            case 38:
            e.preventDefault();
            $image.cropper('move', 0, -1);
            break;
            case 39:
            e.preventDefault();
            $image.cropper('move', 1, 0);
            break;
            case 40:
            e.preventDefault();
            $image.cropper('move', 0, 1);
            break;
        }
      });
        // Import image
        var $inputImage = $('#inputImage'),
        URL = window.URL || window.webkitURL,
        blobURL;
        if (URL) {
            $inputImage.change(function () {
                var files = this.files;
                if (files && files.length) {
                var filePicture = files[0];
                    if (/^image\/\w+$/.test(filePicture.type)) {
                        blobURL = URL.createObjectURL(filePicture);
                        $image.one('built.cropper', function () {
                  URL.revokeObjectURL(blobURL); // Revoke when load complete
              }).cropper('reset', true).cropper('replace', blobURL);
                        $inputImage.val('');
                    } else {
                        alert('Please choose an image file.');
                    }
                }
            });
        } else {
            $inputImage.parent().remove();
        }
}
    

</script>

}